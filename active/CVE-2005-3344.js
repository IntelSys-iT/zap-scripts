/*
 * MIT License
 *
 * Copyright (c) 2022 Sepehrdad
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */

var RISK = 3 // 0: info, 1: low, 2: medium, 3: high
var CONFIDENCE = 3 // 0: falsePositive, 1: low, 2: medium, 3: high, 4: confirmed
var TITLE = "[CVE-2005-3344] Horde Groupware Unauthenticated Admin Access"
var DESCRIPTION = "Horde Groupware contains an administrative account with a blank password, which allows remote attackers to gain access."
var SOLUTION = "Ensure proper firewalls are in place within your environment to prevent public exposure."
var REFERENCE = "https://nvd.nist.gov/vuln/detail/CVE-2005-3344"
var OTHER = "see: http://www.debian.org/security/2005/dsa-884"

function scanNode(as, msg) {

	if (msg.getRequestHeader().getURI().getPath() == null ||
		msg.getRequestHeader().getURI().getPath().length() == 1) {

		var paths = [
			"/horde/admin/user.php",
			"/admin/user.php",
		]

		for (var i in paths) {

			// Copy requests before reusing them
			msg = msg.cloneRequest();

			msg.getRequestHeader().getURI().setPath(paths[i])

			print('[CVE-2005-3344] scan called for url=' + msg.getRequestHeader().getURI().toString());

			// sendAndReceive(msg, followRedirect, handleAntiCSRFtoken)
			as.sendAndReceive(msg, true, true);

			// Test the response here, and make other requests as required
			if (msg.getResponseHeader().getStatusCode() == 200 &&
				msg.getResponseBody().toString().contains("<title>Horde :: User Administration</title>")) {

				as.newAlert()
					.setRisk(RISK)
					.setConfidence(CONFIDENCE)
					.setName(TITLE)
					.setDescription(DESCRIPTION)
					.setEvidence(msg.getRequestHeader().getURI().toString())
					.setOtherInfo(OTHER)
					.setSolution(SOLUTION)
					.setReference(REFERENCE)
					.setMessage(msg)
					.raise()

				return
			}

			if (as.isStop()) {
				return
			}
		}
	}
	return
}

function scan(as, msg, param, value) {
	return
}
